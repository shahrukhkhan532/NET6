name: CI/CD
on:
  push:
    branches:
      - ftp_2
jobs:
  Setup:
    runs-on: windows-2022
    steps:
      - name: Check Out Code ðŸš“
        uses: actions/checkout@v3

      - name: Setup VPN âš™
        shell: PowerShell
        run: |
          ./powershell/VPN.ps1 "PD94bWwgdmVyc2lvbj0iMS4wIj8+DQo8VnBuUHJvZmlsZSB4bWxuczp4c2Q9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIg0KICB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIj4NCiAgPFZwblNlcnZlcj5henVyZWdhdGV3YXktZWZiMTAwNzctNTFjNC00MWFmLWFiNWYtMGJiZDEzYzk4YjczLWEzZTE3MjU3MTNhMy52cG4uYXp1cmUuY29tPC9WcG5TZXJ2ZXI+DQogIDxWcG5UeXBlPlNTVFA8L1ZwblR5cGU+DQogIDxDYUNlcnRzPg0KICAgIDxzdHJpbmc+DQogICAgICBNSUlEcnpDQ0FwZWdBd0lCQWdJUUNEdmdWcEJDUnJHaGRXckpXWkhIU2pBTkJna3Foa2lHOXcwQkFRVUZBREJoTVFzd0NRWURWUVFHRXdKVlV6RVZNQk1HQTFVRUNoTU1SR2xuYVVObGNuUWdTVzVqTVJrd0Z3WURWUVFMRXhCM2QzY3VaR2xuYVdObGNuUXVZMjl0TVNBd0hnWURWUVFERXhkRWFXZHBRMlZ5ZENCSGJHOWlZV3dnVW05dmRDQkRRVEFlRncwd05qRXhNVEF3TURBd01EQmFGdzB6TVRFeE1UQXdNREF3TURCYU1HRXhDekFKQmdOVkJBWVRBbFZUTVJVd0V3WURWUVFLRXd4RWFXZHBRMlZ5ZENCSmJtTXhHVEFYQmdOVkJBc1RFSGQzZHk1a2FXZHBZMlZ5ZEM1amIyMHhJREFlQmdOVkJBTVRGMFJwWjJsRFpYSjBJRWRzYjJKaGJDQlNiMjkwSUVOQk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBNGp2aEVYTGVxS1RUbzFlcVVLS1BDM2VReWFLbDdoTE9sbHNCQ1NETUFaT25UakMzVS9kRHhHa0FWNTNpalNMZGh3WkFBSUVKenM0Ymc3L2Z6VHR4UnVMV1pzY0ZzM1luRm85N25oNlZmZTYzU0tNSTJ0YXZlZ3c1Qm1WL1NsMGZ2QmY0cTc3dUtOZDBmM3A0bVZtRmFHNWNJekpMdjA3QTZGcHQ0M0MvZHhDLy9BSDJoZG1vUkJCWU1xbDFHTlhSb3I1SDRpZHE5Sm96K0VrSVlJdlVYN1E2aEwraHFrcE1mVDdQVDE5c2RsNmdTemVSbnR3aTVtM09GQnFPYXN2K3piTVVaQmZIV3ltZU1yL3k3dnJUQzBMVXE3ZEJNdG9NMU8vNGdkVzdqVmcvdFJ2b1NTaWljTm94Qk4zM3NoYnlUQXBPQjZqdFNqMWV0WCtqa01Pdkp3SURBUUFCbzJNd1lUQU9CZ05WSFE4QkFmOEVCQU1DQVlZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVUE5NVFOVmJSVEx0bThLUGlHeHZEbDdJOTBWVXdId1lEVlIwakJCZ3dGb0FVQTk1UU5WYlJUTHRtOEtQaUd4dkRsN0k5MFZVd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFNdWNONnBJRXhJSyt0MUVuRTlTc1BUZnJnVDFlWGtJb3lRWS9Fc3JoTUF0dWRYSC92VEJIMWpMdUcyY2VuVG5tQ21yRWJYamNLQ2h6VXlJbVpPTWtYRGlxdzhjdnBPcC8yUFY1QWRnMDZPL25Wc0o4ZFdPNDFQMGptUDZQNmZidEdiZlltYlcwVzVCamZJdHRlcDNTcCtkV09JcldjQkFJKzB0S0lKRlBubFVraWFZNElCSXFEZnY4Tlo1WUJiZXJPZ096VzZzUkJjNEwwbmE0VVUrS3JrMlU4ODZVQWIzTHVqRVYwbHNZU0VZMVFTdGVEd3NPb0JycCt1dkZSVHAySW5CdVRoczRwRnNpdjlrdVhjbFZ6REFHeVNqNGR6cDMwZDh0YlFrQ0FVdzdDMjlDNzlGdjFDNXFmUHJtQUVTcmNpSXhwZzBYNDBLUE1icDFaV1ZiZDQ9PC9zdHJpbmc+DQogIDwvQ2FDZXJ0cz4NCiAgPFJvdXRlcz4xMC40LjAuMC8xNiwxMC4xLjAuMC8yNDwvUm91dGVzPg0KICA8QXV0aD5FQVBNU0NIQVBWMjwvQXV0aD4NCiAgPFZuZXROYW1lPlN0YWdpbmctdm5ldDwvVm5ldE5hbWU+DQogIDxWbmV0SWQ+ZWZiMTAwNzctNTFjNC00MWFmLWFiNWYtMGJiZDEzYzk4YjczPC9WbmV0SWQ+DQogIDxTZXJ2ZXJDZXJ0c1Jvb3RDbj4NCiAgICA8c3RyaW5nPkRpZ2lDZXJ0IEdsb2JhbCBSb290IENBPC9zdHJpbmc+DQogIDwvU2VydmVyQ2VydHNSb290Q24+DQogIDxTZXJ2ZXJDZXJ0c0lzc3VlckNuPg0KICAgIDxzdHJpbmc+RGlnaUNlcnQgR2xvYmFsIFJvb3QgQ0E8L3N0cmluZz4NCiAgPC9TZXJ2ZXJDZXJ0c0lzc3VlckNuPg0KICA8VnBuQ2xpZW50QWRkcmVzc1Bvb2w+MTcyLjI1LjAuMC8yNDwvVnBuQ2xpZW50QWRkcmVzc1Bvb2w+DQogIDxBYWRJc3N1ZXIgLz4NCiAgPEFhZFRlbmFudCAvPg0KICA8QWFkQXVkaWVuY2UgLz4NCiAgPEN1c3RvbURuc1NlcnZlcnMgLz4NCjwvVnBuUHJvZmlsZT4="

      - name: Setup Environment Variables ðŸ”Œ
        shell: PowerShell
        run: |
          # ./powershell/Setup.ps1 "${{ github.ref_name }}" "${{ github.actor }}" "webnetworks\Shahrukhsrk" "skR00t@1234!!" "10.4.0.5"
          ./powershell/Setup.ps1 "staging" "${{ github.actor }}" "webnetworks\Shahrukhsrk" "skR00t@1234!!" "10.4.0.5"

      - name: Run-Sql-Scripts ðŸ“œ
        shell: PowerShell
        run: |
          echo $env:Developer__Name
          echo "SHORT ðŸ‘†"
          $SQL_LOG_File_Path = [System.Environment]::GetEnvironmentVariable("SQL_LOG_File_Path", "User")
          # ./powershell/sql.ps1 "10.4.0.4" "iCM_STG" "TestDeployment" 'TestDeployment$' "$SQL_LOG_File_Path"

      - name: Restore Api Dependencies âŒš
        shell: PowerShell
        run: |
          cd NET6  
          # dotnet restore

      - name: Build Api App ðŸš€
        shell: PowerShell
        run: |
          $FilePath = [System.Environment]::GetEnvironmentVariable("BUILD_LOG_File_Path", "User")  
          if (-not (Test-Path $FilePath)) {
            New-Item -Path $FilePath -ItemType File -Force
          }
          $Developer__Name = [System.Environment]::GetEnvironmentVariable("Developer__Name", "User")  
          $URL__Webhook = [System.Environment]::GetEnvironmentVariable("URL__Webhook", "User")  
          
          dotnet build -c Release --no-restore /clp:ErrorsOnly
          
          if($LASTEXITCODE -ne 0){
            $output = (Get-Content $FilePath) | Out-String
            $title = ("A build error was encountered in the API project on the " + "${{ github.ref_name }}" + " branch, following a push by " + "$Developer__Name")
            $title >> $FilePath
            $body = @{
              title = $title
              text = $output
            } | ConvertTo-Json
            # Invoke-RestMethod -Uri "$URL__Webhook" -Method POST -Body $body -ContentType 'application/json'
            EXIT 1
          }

      - name: Publish Api App ðŸ“‘
        shell: PowerShell
        run: |
          $sourcePath = [System.Environment]::GetEnvironmentVariable("sourcePath", "User")
          # dotnet publish -c Release -o ./$sourcePath

      - name: Deploy Api to Server âœ”
        shell: PowerShell
        run: |
          # ./powershell/Deploy.ps1 "${{ github.ref_name }}" "${{ Env.appPoolName }}" ("${{ github.ref_name }}" + "_out") "${{ Env.destinationPath }}" "10.4.0.5" "webnetworks\Shahrukhsrk" "skR00t@1234!!"
          $appPoolName = [System.Environment]::GetEnvironmentVariable("appPoolName", "User")
          $destinationPath = [System.Environment]::GetEnvironmentVariable("destinationPath", "User")
          $sourcePath = [System.Environment]::GetEnvironmentVariable("sourcePath", "User")
          # ./powershell/Deploy.ps1 "staging" "$appPoolName" "$sourcePath" "Z:\test" "10.4.0.5" "webnetworks\Shahrukhsrk" "skR00t@1234!!"

      - name: Notification ðŸ””
        shell: PowerShell
        run: |
          $OutputSQLFilePath = [System.Environment]::GetEnvironmentVariable("SQL_LOG_File_Path", "User")            
          $URL__Webhook = [System.Environment]::GetEnvironmentVariable("URL__Webhook", "User")            
          $message = (Get-Content $OutputSQLFilePath) | Out-String
          Remove-Item -Path $OutputSQLFilePath -Force
          $title = ("The automatic set-up deployment on " + "${{ github.ref_name }}" + " for the API, CareTracker and ICM.API (Reports Project) is complete, please check your work there.")
          $body = @{
            title = $title
            text = $message
          } | ConvertTo-Json
          echo $body
          # Invoke-RestMethod -Uri "$URL__Webhook" -Method POST -Body $body -ContentType 'application/json'

      - name: VPN Dispose âš™
        shell: PowerShell
        run: |
          ./powershell/VPN-Dispose.ps1 "PD94bWwgdmVyc2lvbj0iMS4wIj8+DQo8VnBuUHJvZmlsZSB4bWxuczp4c2Q9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIg0KICB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIj4NCiAgPFZwblNlcnZlcj5henVyZWdhdGV3YXktZWZiMTAwNzctNTFjNC00MWFmLWFiNWYtMGJiZDEzYzk4YjczLWEzZTE3MjU3MTNhMy52cG4uYXp1cmUuY29tPC9WcG5TZXJ2ZXI+DQogIDxWcG5UeXBlPlNTVFA8L1ZwblR5cGU+DQogIDxDYUNlcnRzPg0KICAgIDxzdHJpbmc+DQogICAgICBNSUlEcnpDQ0FwZWdBd0lCQWdJUUNEdmdWcEJDUnJHaGRXckpXWkhIU2pBTkJna3Foa2lHOXcwQkFRVUZBREJoTVFzd0NRWURWUVFHRXdKVlV6RVZNQk1HQTFVRUNoTU1SR2xuYVVObGNuUWdTVzVqTVJrd0Z3WURWUVFMRXhCM2QzY3VaR2xuYVdObGNuUXVZMjl0TVNBd0hnWURWUVFERXhkRWFXZHBRMlZ5ZENCSGJHOWlZV3dnVW05dmRDQkRRVEFlRncwd05qRXhNVEF3TURBd01EQmFGdzB6TVRFeE1UQXdNREF3TURCYU1HRXhDekFKQmdOVkJBWVRBbFZUTVJVd0V3WURWUVFLRXd4RWFXZHBRMlZ5ZENCSmJtTXhHVEFYQmdOVkJBc1RFSGQzZHk1a2FXZHBZMlZ5ZEM1amIyMHhJREFlQmdOVkJBTVRGMFJwWjJsRFpYSjBJRWRzYjJKaGJDQlNiMjkwSUVOQk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBNGp2aEVYTGVxS1RUbzFlcVVLS1BDM2VReWFLbDdoTE9sbHNCQ1NETUFaT25UakMzVS9kRHhHa0FWNTNpalNMZGh3WkFBSUVKenM0Ymc3L2Z6VHR4UnVMV1pzY0ZzM1luRm85N25oNlZmZTYzU0tNSTJ0YXZlZ3c1Qm1WL1NsMGZ2QmY0cTc3dUtOZDBmM3A0bVZtRmFHNWNJekpMdjA3QTZGcHQ0M0MvZHhDLy9BSDJoZG1vUkJCWU1xbDFHTlhSb3I1SDRpZHE5Sm96K0VrSVlJdlVYN1E2aEwraHFrcE1mVDdQVDE5c2RsNmdTemVSbnR3aTVtM09GQnFPYXN2K3piTVVaQmZIV3ltZU1yL3k3dnJUQzBMVXE3ZEJNdG9NMU8vNGdkVzdqVmcvdFJ2b1NTaWljTm94Qk4zM3NoYnlUQXBPQjZqdFNqMWV0WCtqa01Pdkp3SURBUUFCbzJNd1lUQU9CZ05WSFE4QkFmOEVCQU1DQVlZd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVUE5NVFOVmJSVEx0bThLUGlHeHZEbDdJOTBWVXdId1lEVlIwakJCZ3dGb0FVQTk1UU5WYlJUTHRtOEtQaUd4dkRsN0k5MFZVd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFNdWNONnBJRXhJSyt0MUVuRTlTc1BUZnJnVDFlWGtJb3lRWS9Fc3JoTUF0dWRYSC92VEJIMWpMdUcyY2VuVG5tQ21yRWJYamNLQ2h6VXlJbVpPTWtYRGlxdzhjdnBPcC8yUFY1QWRnMDZPL25Wc0o4ZFdPNDFQMGptUDZQNmZidEdiZlltYlcwVzVCamZJdHRlcDNTcCtkV09JcldjQkFJKzB0S0lKRlBubFVraWFZNElCSXFEZnY4Tlo1WUJiZXJPZ096VzZzUkJjNEwwbmE0VVUrS3JrMlU4ODZVQWIzTHVqRVYwbHNZU0VZMVFTdGVEd3NPb0JycCt1dkZSVHAySW5CdVRoczRwRnNpdjlrdVhjbFZ6REFHeVNqNGR6cDMwZDh0YlFrQ0FVdzdDMjlDNzlGdjFDNXFmUHJtQUVTcmNpSXhwZzBYNDBLUE1icDFaV1ZiZDQ9PC9zdHJpbmc+DQogIDwvQ2FDZXJ0cz4NCiAgPFJvdXRlcz4xMC40LjAuMC8xNiwxMC4xLjAuMC8yNDwvUm91dGVzPg0KICA8QXV0aD5FQVBNU0NIQVBWMjwvQXV0aD4NCiAgPFZuZXROYW1lPlN0YWdpbmctdm5ldDwvVm5ldE5hbWU+DQogIDxWbmV0SWQ+ZWZiMTAwNzctNTFjNC00MWFmLWFiNWYtMGJiZDEzYzk4YjczPC9WbmV0SWQ+DQogIDxTZXJ2ZXJDZXJ0c1Jvb3RDbj4NCiAgICA8c3RyaW5nPkRpZ2lDZXJ0IEdsb2JhbCBSb290IENBPC9zdHJpbmc+DQogIDwvU2VydmVyQ2VydHNSb290Q24+DQogIDxTZXJ2ZXJDZXJ0c0lzc3VlckNuPg0KICAgIDxzdHJpbmc+RGlnaUNlcnQgR2xvYmFsIFJvb3QgQ0E8L3N0cmluZz4NCiAgPC9TZXJ2ZXJDZXJ0c0lzc3VlckNuPg0KICA8VnBuQ2xpZW50QWRkcmVzc1Bvb2w+MTcyLjI1LjAuMC8yNDwvVnBuQ2xpZW50QWRkcmVzc1Bvb2w+DQogIDxBYWRJc3N1ZXIgLz4NCiAgPEFhZFRlbmFudCAvPg0KICA8QWFkQXVkaWVuY2UgLz4NCiAgPEN1c3RvbURuc1NlcnZlcnMgLz4NCjwvVnBuUHJvZmlsZT4="
